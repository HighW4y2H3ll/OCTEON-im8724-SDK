<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Octeon Software Development Kit: OCTEON SDK config and build system</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="build">OCTEON SDK config and build system </a></h1><h2><a class="anchor" id="build_intro">
1. Introduction</a></h2>
<p>The OCTEON SDK config and build system builds the simple executive library, in the common directory if the library is not present or any changes made to the simple executive files.</p>
<p>The build system for simple executive supports building 64-bit and 32-bit applications. By default 64-bit applications are built and the object files are placed in the 'obj-octeon' directory under $OCTEON_ROOT/executive directory.</p>
<p>When the envionment is sourced with OCTEON II model, for example OCTEON_CN63XX, the application is compiled with -march=octeon2 ISA. This toolchain option generates OCTEON II specific instructions. The application will not run on OCTEON and OCTEON Plus models, will run on OCTEON II and OCTEON III processor. The object files and library are placed in the 'obj-octeon2' directory under $OCTEON_ROOT/executive directory.</p>
<p>Based on the configuration, specific to the application, respective functions are linked into the application from the library.</p>
<p>To build the library in a different directory pass OCTEON_EXEC_DIR=DIR to make command. If "OCTEON_EXEC_DIR=mylibdir make" command is invoked, then object files and library are created under mylibdir directory.</p>
<p>The build system supports building for either compile time or runtime OCTEON model selection. Please see the "Supporting multiple OCTEON models" section of the simple executive documentation page and <a class="el" href="octeon-model_8h.html" title="File defining different Octeon model IDs and macros to compare them.">octeon-model.h</a> for more details.</p>
<h2><a class="anchor" id="build_2">
2. How to use</a></h2>
<p>To use the build system, the application Makefile should use the template provided below. The template provides the proper order of inclusion for the various Makefile fragments provided by the build system, such as common.mk, cvmx.mk and application.mk. If additional components are used in the application, the component will provide a component Makefile fragment to be included as well. Below is the application Makefile template showing an application target "app_exe" being built from "app1.c" and "app2.c":</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor">#  application Makefile</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor">#  $Id: doc-build-system.h 128470 2015-11-19 23:27:42Z cchavva $</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor">#    subdirectory config/ contains all the configuration header files.</span>
<span class="preprocessor"></span><span class="preprocessor">#        for example config/cvmx-config.h contains the system resource config,</span>
<span class="preprocessor"></span><span class="preprocessor">#        config/executive-config.h contains the simple executive config,</span>
<span class="preprocessor"></span><span class="preprocessor">#        config/global-config.h contains global config across components,</span>
<span class="preprocessor"></span><span class="preprocessor">#        config/comp1-config.h contains component config for comp1.</span>
<span class="preprocessor"></span><span class="preprocessor">#    subdirectory obj-octeonX/ contains intermediate build and library files.</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span>
<span class="preprocessor">#  default target</span>
<span class="preprocessor"></span>
<span class="keywordflow">default</span>: application-target

<span class="preprocessor">#  standard common Makefile fragment</span>
<span class="preprocessor"></span>
include $(OCTEON_ROOT)/common.mk

#  include needed component Makefile fragments

dir := $(OCTEON_ROOT)/executive
include $(dir)/cvmx.mk

# dir := $(OCTEON_ROOT)/components/comp1
<span class="preprocessor"># include $(dir)/comp1.mk</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor"># dir := $(OCTEON_ROOT)/components/comp2</span>
<span class="preprocessor"></span><span class="preprocessor"># include $(dir)/comp2.mk</span>
<span class="preprocessor"></span>
<span class="preprocessor">#  application specification</span>
<span class="preprocessor"></span>
TARGET        =  app_exe$(PREFIX)

OBJS          =  $(OBJ_DIR)/app1.o $(OBJ_DIR)/app2.o

CFLAGS_LOCAL = -g -O2 -W -Wall -Wno-unused-parameter

include $(OCTEON_ROOT)/application.mk

<span class="preprocessor">#  clean target</span>
<span class="preprocessor"></span>
clean:
    rm -f $(TARGET)
    rm -f $(CVMX_CONFIG)
    rm -fr $(OBJ_DIR)
</pre></div><p>Some items have special meaning:</p>
<ul>
<li>application-target: This target depends on the TARGET variable and provides a way to intercept the default make target prior to the value of TARGET being defined.</li>
<li>dir: For each component needed by the application, this variable needs to be set to where the component source is located. Note the required immediate evaluation assignment syntax.</li>
<li>TARGET: The name of the application to be built.</li>
<li>OBJS: Each application source file should have its corresponding object file listed here.</li>
<li>CFLAGS_LOCAL: CFLAGS that will be used for building files listed in OBJS.</li>
</ul>
<p>This build system should be used for applications that require cvmx-config.h (system resource config). All SDK examples that need cvmx-config.h use this build system.</p>
<h2><a class="anchor" id="build_2_1">
2.1 Environment variables and global configuration</a></h2>
<p>There are several environment variables that can be used to add options to various stages of the build. These are:</p>
<ul>
<li>OCTEON_CPPFLAGS_GLOBAL_ADD</li>
<li>OCTEON_CFLAGS_GLOBAL_ADD</li>
<li>OCTEON_ASFLAGS_GLOBAL_ADD</li>
<li>OCTEON_LDFLAGS_GLOBAL_ADD</li>
</ul>
<p>The contents of these variables (if defined) will be added to the respective FLAGS variable in the build system. The build system current uses OCTEON_CPPFLAGS_GLOBAL_ADD for the following configuration options:</p>
<ul>
<li>runtime model checking: Runtime model checking is optionally enabled by the env-setup script. This is done by adding the "-DUSE_RUNTIME_MODEL_CHECKS=1" to this environment variable. This is the default behaviour.</li>
<li>runtime checking of POW consistency, CSR addresses, and other parameters: To enable this, pass the --checks argument to the env-setup script. This is _strongly_ recommended, as it can identify coding errors that may be difficult to find otherwise.</li>
<li>To use 1-1 TLB mappings for simple executive application:. Its disabled by default. To enable use of 1-1 mappings, the string "CVMX_USE_1_TO_1_TLB_MAPPINGS=1" to the environment variable. This will cause the application initialization code to setup 1-1 mappings, and also <a class="el" href="cvmx-access_8h.html#a9adf20d6b29145111460ecbc6fbca3dd" title="Convert a hardware physical address (uint64_t) into a memory pointer (void *).">cvmx_phys_to_ptr()</a> and <a class="el" href="cvmx-access_8h.html#a76ed79b4650d01f82f1f517be07fe7c5" title="Convert a memory pointer (void*) into a hardware compatable memory address (uint64_t)...">cvmx_ptr_to_phys()</a> to do the proper convertions.</li>
</ul>
<h2><a class="anchor" id="build_3">
3.  Config system</a></h2>
<p>Each component in the SDK may have configuration settings, which are specified in the cvmx-config.h header file. When creating a new application, a config subdirectory should be created, and application-specific config header files should be placed in the config subdirectory. Templates (starting points) for such config header files can be found in the component directory as component-config.h.template. For example, the simple executive's configuration header file template is found at OCTEON-SDK/executive/executive-config.h.template. The application should make a copy of it in the application directory as config/executive-config.h.</p>
<div class="fragment"><pre class="fragment">Example: creating an application that uses simple executive

% mkdir application
% cd application
% mkdir config
% cp $OCTEON_ROOT/executive/executive-config.h.template config/executive-config.h

(then edit executive-config.h to tune the flags/settings as appropriate <span class="keywordflow">for</span> the application)
</pre></div><p>The build system will take care of creating a system resource header file, by running the cvmx-config tool on all the configuration header files in the application's config subdirectory. The automatically generated file will be config/cvmx-config.h.</p>
<p>The application can specify its own config/resource requirements via this system as well. All header files of the form config/*-config.h will be picked up by the config/build system.</p>
<p>Each component-config.h file contains two sections: first, the component configuration section should detail the various compilation flags and settings that can be defined to control the behavior of that particular component. Flags may be used to enable/disable features, settings may be used to define parameters required for that component. This section is normal C code.</p>
<p>The second section contains the resource requirements of the component. This section is not C code, and is therefore bracketed by #ifdef CAVIUM_COMPONENT_REQUIREMENT/#endif. The resource requirement section may be split into another file and included in the component-config.h file. This is done for the simple executive with the resources described in the cvmx-resources.config file that is included by executive-config.h.</p>
<p>The resource requirements are always specified in the format of section name "cvmxconfig", followed by open brace, followed by the resource requirement specifications, then finally ending with a close brace.</p>
<div class="fragment"><pre class="fragment">cvmxconfig
{
    ... resource requirement specifications go here ...
}
</pre></div><p>There are three types of resources requirements: fpa, fau, and scratch.</p>
<p>Each resource specification start with the resource type, followed by the definition name (the name of macros that will end up in the generated cvmx-config.h), followed by a series of name = value pairs, terminating with semicolon.</p>
<p>For fpa resource specification, the following name value pairs are recognized:</p>
<div class="fragment"><pre class="fragment"> pool = &lt;integer&gt;        ranges from 0 through 7, specifies the required <a class="code" href="cvmx-ocla_8h.html#ab1524b0c8e1b468e73bd7e73d7748c69a750d4f2d43775053be32d6d845aa4d30">FPA</a> pool number, <span class="keywordflow">for</span> pools that must be fixed.
 size = &lt;integer&gt;        specifies the size of buffers in the pool in number of cache lines.  (<span class="keywordflow">default</span>: 1)
 priority = &lt;integer&gt;    ranges from 1 through 8, specifies the desired priority (1 = highest priority).  (<span class="keywordflow">default</span>: 8)
 <span class="keyword">protected</span> = &lt;<span class="keywordtype">boolean</span>&gt;   <span class="keywordflow">if</span> <span class="keyword">true</span>, no other fpa resource can map to the hardware pool assigned to <span class="keyword">this</span> resource.  (<span class="keywordflow">default</span>: <span class="keyword">false</span>)
 description = &lt;<span class="keywordtype">string</span>&gt;  doubly quoted string, which will appear as comment in the generated cvmx-config.h.

 &lt;<span class="keywordtype">boolean</span>&gt; can be <span class="stringliteral">&quot;true&quot;</span>, <span class="stringliteral">&quot;yes&quot;</span>, or <span class="stringliteral">&quot;1&quot;</span> <span class="keywordflow">for</span> <span class="keyword">true</span>, and <span class="stringliteral">&quot;false&quot;</span>, <span class="stringliteral">&quot;no&quot;</span>, or <span class="stringliteral">&quot;0&quot;</span> <span class="keywordflow">for</span> <span class="keyword">false</span>.
</pre></div><div class="fragment"><pre class="fragment"> Example fpa resource specification: the packet buffer pool

            fpa CVMX_FPA_PACKET_POOL
                    pool        = 0
                    size        = 8
                    priority    = 1
                    description = <span class="stringliteral">&quot;Packet buffers&quot;</span>;
</pre></div><p>For fau resource specification, the following name value pairs are recognized:</p>
<div class="fragment"><pre class="fragment"> size = &lt;integer&gt;        specifies the number of bytes per element.  (<span class="keywordflow">default</span>: 8)
 count = &lt;integer&gt;       specifies the number of elements.  (<span class="keywordflow">default</span>: 1)
 description = &lt;<span class="keywordtype">string</span>&gt;  doubly quoted string, which will appear as comment in the generated cvmx-config.h.
</pre></div><div class="fragment"><pre class="fragment"> Example fau resource specification: an array of 8 bytes <span class="keywordflow">for</span> output queue index

            fau CVMX_FAU_REG_OQ_INDEX_BASE
                    size        = 1
                    count       = 8
                    description = <span class="stringliteral">&quot;FAU registers for the position in PKO command buffers&quot;</span>;
</pre></div><p>For scratch resource specification, the following name value pairs are recognized:</p>
<div class="fragment"><pre class="fragment"> permanent = &lt;<span class="keywordtype">boolean</span>&gt;   <span class="keywordflow">if</span> <span class="keyword">true</span>, <span class="keyword">this</span> scratch location cannot be shared with another scratch resource.  (<span class="keywordflow">default</span>: <span class="keyword">true</span>)
 size = &lt;integer&gt;        specifies the number of bytes per element.  (<span class="keywordflow">default</span>: 8)
 count = &lt;integer&gt;       specifies the number of elements.  (<span class="keywordflow">default</span>: 1)
 iobdma = &lt;<span class="keywordtype">boolean</span>&gt;      <span class="keywordflow">if</span> <span class="keyword">true</span>, <span class="keyword">this</span> scratch location can be used as an IOBDMA destination.  (<span class="keywordflow">default</span>: <span class="keyword">true</span>)
</pre></div><div class="fragment"><pre class="fragment"> Example scratch resource specification: output queue buffer preallocation

            scratch CVMX_SCR_OQ_BUF_PRE_ALLOC
                    size        = 8
                    iobdma      = <span class="keyword">true</span>
                    permanent   = <span class="keyword">true</span>
                    description = <span class="stringliteral">&quot;Pre allocation for PKO queue command buffers&quot;</span>;
</pre></div> </div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 27 Oct 2017 for Octeon Software Development Kit by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
