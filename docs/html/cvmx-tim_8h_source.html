<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Octeon Software Development Kit: cvmx-tim.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>cvmx-tim.h</h1><a href="cvmx-tim_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***********************license start***************</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2003-2010  Cavium Inc. (support@cavium.com). All rights</span>
<a name="l00003"></a>00003 <span class="comment"> * reserved.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00007"></a>00007 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00008"></a>00008 <span class="comment"> * met:</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> *   * Redistributions of source code must retain the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *     notice, this list of conditions and the following disclaimer.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> *   * Redistributions in binary form must reproduce the above</span>
<a name="l00014"></a>00014 <span class="comment"> *     copyright notice, this list of conditions and the following</span>
<a name="l00015"></a>00015 <span class="comment"> *     disclaimer in the documentation and/or other materials provided</span>
<a name="l00016"></a>00016 <span class="comment"> *     with the distribution.</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment"> *   * Neither the name of Cavium Inc. nor the names of</span>
<a name="l00019"></a>00019 <span class="comment"> *     its contributors may be used to endorse or promote products</span>
<a name="l00020"></a>00020 <span class="comment"> *     derived from this software without specific prior written</span>
<a name="l00021"></a>00021 <span class="comment"> *     permission.</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment"> * This Software, including technical data, may be subject to U.S. export  control</span>
<a name="l00024"></a>00024 <span class="comment"> * laws, including the U.S. Export Administration Act and its  associated</span>
<a name="l00025"></a>00025 <span class="comment"> * regulations, and may be subject to export or import  regulations in other</span>
<a name="l00026"></a>00026 <span class="comment"> * countries.</span>
<a name="l00027"></a>00027 <span class="comment"></span>
<a name="l00028"></a>00028 <span class="comment"> * TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED &quot;AS IS&quot;</span>
<a name="l00029"></a>00029 <span class="comment"> * AND WITH ALL FAULTS AND CAVIUM INC. MAKES NO PROMISES, REPRESENTATIONS OR</span>
<a name="l00030"></a>00030 <span class="comment"> * WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO</span>
<a name="l00031"></a>00031 <span class="comment"> * THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY REPRESENTATION OR</span>
<a name="l00032"></a>00032 <span class="comment"> * DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT DEFECTS, AND CAVIUM</span>
<a name="l00033"></a>00033 <span class="comment"> * SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES OF TITLE,</span>
<a name="l00034"></a>00034 <span class="comment"> * MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE, LACK OF</span>
<a name="l00035"></a>00035 <span class="comment"> * VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION OR</span>
<a name="l00036"></a>00036 <span class="comment"> * CORRESPONDENCE TO DESCRIPTION. THE ENTIRE  RISK ARISING OUT OF USE OR</span>
<a name="l00037"></a>00037 <span class="comment"> * PERFORMANCE OF THE SOFTWARE LIES WITH YOU.</span>
<a name="l00038"></a>00038 <span class="comment"> ***********************license end**************************************/</span>
<a name="l00039"></a>00039 <span class="comment"></span>
<a name="l00040"></a>00040 <span class="comment">/**</span>
<a name="l00041"></a>00041 <span class="comment"> * @file</span>
<a name="l00042"></a>00042 <span class="comment"> *</span>
<a name="l00043"></a>00043 <span class="comment"> * Interface to the hardware work queue timers.</span>
<a name="l00044"></a>00044 <span class="comment"> *</span>
<a name="l00045"></a>00045 <span class="comment">`* &lt;hr&gt;$Revision: 166783 $&lt;hr&gt;</span>
<a name="l00046"></a>00046 <span class="comment"> */</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#ifndef __CVMX_TIM_H__</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#define __CVMX_TIM_H__</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="cvmx-clock_8h.html" title="Interface to Core, IO and DDR Clock.">cvmx-clock.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="cvmx-fpa_8h.html" title="Interface to the hardware Free Pool Allocator.">cvmx-fpa.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="cvmx-wqe_8h.html" title="This header file defines the work queue entry (wqe) data structure.">cvmx-wqe.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="cvmx-spinlock_8h.html" title="Implementation of spinlocks.">cvmx-spinlock.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="cvmx-utils_8h.html" title="Small utility functions and macros to ease programming of Octeon.">cvmx-utils.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="comment">//#include &quot;cvmx-bootmem.h&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#ifdef  __cplusplus</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="comment">/* *INDENT-OFF* */</span>
<a name="l00060"></a>00060 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00061"></a>00061 <span class="comment">/* *INDENT-ON* */</span>
<a name="l00062"></a>00062 <span class="preprocessor">#endif</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span> 
<a name="l00064"></a><a class="code" href="cvmx-tim_8h.html#addfa093ac0ea25113d191520e1e7a5a4">00064</a> <span class="preprocessor">#define CVMX_TIM_NUM_TIMERS  (cvmx_tim_num_rings())</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a><a class="code" href="cvmx-tim_8h.html#a67af277495f9f36fc9e79f726ca23392">00066</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a class="code" href="cvmx-tim_8h.html#a67af277495f9f36fc9e79f726ca23392">cvmx_tim_num_rings</a>(<span class="keywordtype">void</span>)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     <span class="keyword">static</span> <span class="keywordtype">unsigned</span> processed = 0;
<a name="l00069"></a>00069     <span class="keywordflow">if</span> (processed)
<a name="l00070"></a>00070         <span class="keywordflow">return</span> processed;
<a name="l00071"></a>00071     
<a name="l00072"></a>00072     <span class="keywordflow">if</span> (<a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#ad28aa505bb4f34bb5f894ca14a8b7ba3">OCTEON_CN68XX</a>))
<a name="l00073"></a>00073         processed = 64;
<a name="l00074"></a>00074     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a1deef61f201401bab191e2ab4a1d05a6">OCTEON_CN78XX</a>)) 
<a name="l00075"></a>00075         processed = 64;
<a name="l00076"></a>00076     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a3018e90a8278d961f5f829b40c36b0ae">OCTEON_CN73XX</a>)) 
<a name="l00077"></a>00077         processed = 64;
<a name="l00078"></a>00078     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a40a5b22bfd5e1eefdaa689463f9a8d30">OCTEON_CNF75XX</a>)) 
<a name="l00079"></a>00079         processed = 64;
<a name="l00080"></a>00080     <span class="keywordflow">else</span>
<a name="l00081"></a>00081         processed = 16;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keywordflow">return</span> processed;
<a name="l00084"></a>00084     
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="cvmx-tim_8h.html#a5f735018e044ec7a5a5d9892e73d9973">00087</a> <span class="preprocessor">#define CVMX_TIM_NUM_BUCKETS  2048 </span><span class="comment">/* According to HRM, this should be 4096; revisit */</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">/*</span>
<a name="l00090"></a>00090 <span class="comment"> * This define must match the value in</span>
<a name="l00091"></a>00091 <span class="comment"> * linux/arch/mips/include/uapi/asm/sysmips.h</span>
<a name="l00092"></a>00092 <span class="comment"> */</span>
<a name="l00093"></a><a class="code" href="cvmx-tim_8h.html#a7a6976e5763003410ab18a1213276b4b">00093</a> <span class="preprocessor">#define MIPS_CAVIUM_ARM_TIMER    2012</span>
<a name="l00094"></a><a class="code" href="cvmx-tim_8h.html#ac3c2d2f9982e8caa5a34538b397832b0">00094</a> <span class="preprocessor"></span><span class="preprocessor">#define MIPS_CAVIUM_DISARM_TIMER 2013</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>
<a name="l00096"></a><a class="code" href="cvmx-tim_8h.html#a534dfde0972aded564e226065ff6dba4">00096</a> <span class="preprocessor">#define TIM_DEBUG 0</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a>00098 <span class="comment">/*</span>
<a name="l00099"></a>00099 <span class="comment"> * This enum must be kept in sync with the one in</span>
<a name="l00100"></a>00100 <span class="comment"> * linux/arch/mips/cavium-octeon/cavium.c</span>
<a name="l00101"></a>00101 <span class="comment"> */</span>
<a name="l00102"></a><a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04b">00102</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l00103"></a><a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba093734bbb3d3582b0f8ae0e5705606e5">00103</a>     <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba093734bbb3d3582b0f8ae0e5705606e5">CVMX_TIM_STATUS_SUCCESS</a> = 0,
<a name="l00104"></a><a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04baa8396391c0d8e26ec7a68e1e32732ed5">00104</a>     <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04baa8396391c0d8e26ec7a68e1e32732ed5">CVMX_TIM_STATUS_NO_MEMORY</a> = -1,
<a name="l00105"></a><a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04bade80cb02a77907646a5697edae049f93">00105</a>     <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04bade80cb02a77907646a5697edae049f93">CVMX_TIM_STATUS_TOO_FAR_AWAY</a> = -2,
<a name="l00106"></a><a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba69d4c652d57d7cfddc74eede38e59dd6">00106</a>     <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba69d4c652d57d7cfddc74eede38e59dd6">CVMX_TIM_STATUS_BUSY</a> = -3,
<a name="l00107"></a><a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba79a71ebc570006ec4ef747afe55bceec">00107</a>     <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba79a71ebc570006ec4ef747afe55bceec">CVMX_TIM_STATUS_LOCK</a> = -4,
<a name="l00108"></a><a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04babd355246e724679d4b09d2017367872b">00108</a>     <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04babd355246e724679d4b09d2017367872b">CVMX_TIM_STATUS_NOT_SUPPORTED</a> = -4
<a name="l00109"></a>00109 } <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04b">cvmx_tim_status_t</a>;
<a name="l00110"></a>00110 <span class="comment"></span>
<a name="l00111"></a>00111 <span class="comment">/**</span>
<a name="l00112"></a>00112 <span class="comment"> * Each timer bucket contains a list of work queue entries to</span>
<a name="l00113"></a>00113 <span class="comment"> * schedule when the timer fires. The list is implemented as</span>
<a name="l00114"></a>00114 <span class="comment"> * a linked list of blocks. Each block contains an array of</span>
<a name="l00115"></a>00115 <span class="comment"> * work queue entries followed by a next block pointer. Since</span>
<a name="l00116"></a>00116 <span class="comment"> * these blocks are dynamically allocated off of a hardware</span>
<a name="l00117"></a>00117 <span class="comment"> * memory pool, there actual size isn&apos;t known compile time.</span>
<a name="l00118"></a>00118 <span class="comment"> * The next block pointer is stored in the last 8 bytes of</span>
<a name="l00119"></a>00119 <span class="comment"> * the memory block.</span>
<a name="l00120"></a>00120 <span class="comment"> */</span>
<a name="l00121"></a><a class="code" href="structcvmx__tim__entry__chunk.html">00121</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structcvmx__tim__entry__chunk.html" title="Each timer bucket contains a list of work queue entries to schedule when the timer...">cvmx_tim_entry_chunk</a> {
<a name="l00122"></a><a class="code" href="structcvmx__tim__entry__chunk.html#ab83f18c163b4d12fa9eff96b1e7e3491">00122</a>     <span class="keyword">volatile</span> uint64_t <a class="code" href="structcvmx__tim__entry__chunk.html#ab83f18c163b4d12fa9eff96b1e7e3491">entries</a>[0];
<a name="l00123"></a>00123 } <a class="code" href="structcvmx__tim__entry__chunk.html" title="Each timer bucket contains a list of work queue entries to schedule when the timer...">cvmx_tim_entry_chunk_t</a>;
<a name="l00124"></a>00124 <span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">/**</span>
<a name="l00126"></a>00126 <span class="comment"> * Each timer contains an array of buckets. Each bucket</span>
<a name="l00127"></a>00127 <span class="comment"> * represents the list of work queue entries that should be</span>
<a name="l00128"></a>00128 <span class="comment"> * scheduled when the timer fires.  The first 3 entries are used</span>
<a name="l00129"></a>00129 <span class="comment"> * byt the hardware.</span>
<a name="l00130"></a>00130 <span class="comment"> */</span>
<a name="l00131"></a><a class="code" href="structcvmx__tim__bucket__entry__t.html">00131</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00132"></a><a class="code" href="structcvmx__tim__bucket__entry__t.html#a926a3397881d680bb429ff0e7aeeabbc">00132</a>     <span class="keyword">volatile</span> uint64_t first_chunk_addr;
<a name="l00133"></a>00133 <span class="preprocessor">#if __BYTE_ORDER == __BIG_ENDIAN</span>
<a name="l00134"></a><a class="code" href="structcvmx__tim__bucket__entry__t.html#a50fe96f8f22f082c60b9a7500c5823ed">00134</a> <span class="preprocessor"></span>    <span class="keyword">volatile</span> uint32_t num_entries;          <span class="comment">/**&lt; Zeroed by HW after traversing list */</span>
<a name="l00135"></a><a class="code" href="structcvmx__tim__bucket__entry__t.html#a10b1638f2e9401392ba35f4b4da08769">00135</a>     <span class="keyword">volatile</span> uint32_t chunk_remainder;      <span class="comment">/**&lt; Zeroed by HW after traversing list */</span>
<a name="l00136"></a>00136 <span class="preprocessor">#else</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    <span class="keyword">volatile</span> uint32_t num_entries;          <span class="comment">/**&lt; Zeroed by HW after traversing list */</span>
<a name="l00138"></a>00138     <span class="keyword">volatile</span> uint32_t chunk_remainder;      <span class="comment">/**&lt; Zeroed by HW after traversing list */</span>
<a name="l00139"></a>00139 <span class="preprocessor">#endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>    <span class="comment">/* the remaining 16 bytes are not touched by hardware */</span>
<a name="l00141"></a><a class="code" href="structcvmx__tim__bucket__entry__t.html#a5857db1bb4ee4b265f8c30dd884c28d9">00141</a>     <span class="keyword">volatile</span> <a class="code" href="structcvmx__tim__entry__chunk.html" title="Each timer bucket contains a list of work queue entries to schedule when the timer...">cvmx_tim_entry_chunk_t</a> *last_chunk;<span class="comment">/* this should be 8 bytes */</span>
<a name="l00142"></a><a class="code" href="structcvmx__tim__bucket__entry__t.html#a2372977c885ae517d7076a45ec0c3290">00142</a>     uint64_t pad;
<a name="l00143"></a>00143 } <a class="code" href="structcvmx__tim__bucket__entry__t.html" title="Each timer contains an array of buckets.">cvmx_tim_bucket_entry_t</a>;
<a name="l00144"></a>00144 <span class="comment"></span>
<a name="l00145"></a>00145 <span class="comment">/**</span>
<a name="l00146"></a>00146 <span class="comment"> * Structure representing an individual timer. Each timer has</span>
<a name="l00147"></a>00147 <span class="comment"> * a timer period, a memory management pool, and a list of</span>
<a name="l00148"></a>00148 <span class="comment"> * buckets.</span>
<a name="l00149"></a>00149 <span class="comment"> *</span>
<a name="l00150"></a>00150 <span class="comment"> * This structure must be kept in sync with cvmx_tim_kernel_t.</span>
<a name="l00151"></a>00151 <span class="comment"> */</span>
<a name="l00152"></a><a class="code" href="structcvmx__tim__t.html">00152</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00153"></a><a class="code" href="structcvmx__tim__t.html#ab7f4fb83deeec9a6cc23575cd13d8ec3">00153</a>     <a class="code" href="structcvmx__tim__bucket__entry__t.html" title="Each timer contains an array of buckets.">cvmx_tim_bucket_entry_t</a> *bucket;    <span class="comment">/**&lt; The timer buckets. Array of [CVMX_TIM_NUM_TIMERS][CVMX_TIM_NUM_BUCKETS] */</span>
<a name="l00154"></a><a class="code" href="structcvmx__tim__t.html#a487fcc2bd20a66486bb3278e520a9f8b">00154</a>     uint64_t tick_cycles;           <span class="comment">/**&lt; How long a bucket represents */</span>
<a name="l00155"></a><a class="code" href="structcvmx__tim__t.html#a6c2d8abe0f5065fd89f4498d1f8b8b14">00155</a>     uint64_t start_time;            <span class="comment">/**&lt; Time the timer started in cycles */</span>
<a name="l00156"></a>00156 <span class="preprocessor">#if __BYTE_ORDER == __BIG_ENDIAN</span>
<a name="l00157"></a><a class="code" href="structcvmx__tim__t.html#a70b6e28fb84dd62f64476db821271522">00157</a> <span class="preprocessor"></span>    uint32_t bucket_shift;          <span class="comment">/**&lt; How long a bucket represents in ms */</span>
<a name="l00158"></a><a class="code" href="structcvmx__tim__t.html#aa99c1b51daa13086d722f1b6e05a9e27">00158</a>     uint32_t num_buckets;           <span class="comment">/**&lt; How many buckets per wheel */</span>
<a name="l00159"></a><a class="code" href="structcvmx__tim__t.html#a44257e448bced8cc1369bf2b00333864">00159</a>     uint32_t max_ticks;         <span class="comment">/**&lt; maximum number of ticks allowed for timer */</span>
<a name="l00160"></a><a class="code" href="structcvmx__tim__t.html#a86b41cc7fc6a1fec4e259d1bc9833c05">00160</a>     uint32_t num_rings;         <span class="comment">/**&lt; number of rings available */</span>
<a name="l00161"></a>00161 <span class="preprocessor">#else</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span>    uint32_t num_buckets;           <span class="comment">/**&lt; How many buckets per wheel */</span>
<a name="l00163"></a>00163     uint32_t bucket_shift;          <span class="comment">/**&lt; How long a bucket represents in ms */</span>
<a name="l00164"></a>00164     uint32_t num_rings;         <span class="comment">/**&lt; number of rings available */</span>
<a name="l00165"></a>00165     uint32_t max_ticks;         <span class="comment">/**&lt; maximum number of ticks allowed for timer */</span>
<a name="l00166"></a>00166 <span class="preprocessor">#endif</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>} <a class="code" href="structcvmx__tim__t.html" title="Structure representing an individual timer.">cvmx_tim_t</a>;
<a name="l00168"></a>00168 <span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">/**</span>
<a name="l00170"></a>00170 <span class="comment"> * Structure representing an individual timer. Each timer has</span>
<a name="l00171"></a>00171 <span class="comment"> * a timer period, a memory management pool, and a list of</span>
<a name="l00172"></a>00172 <span class="comment"> * buckets.</span>
<a name="l00173"></a>00173 <span class="comment"> *</span>
<a name="l00174"></a>00174 <span class="comment"> * This is the structure passed to the kernel. It must be kept in sync with</span>
<a name="l00175"></a>00175 <span class="comment"> * cvmx_tim_t in this file and in linux/arch/mips/cavium-octeon/cavium.c.</span>
<a name="l00176"></a>00176 <span class="comment"></span>
<a name="l00177"></a>00177 <span class="comment"> * @INTERNAL</span>
<a name="l00178"></a>00178 <span class="comment"> */</span>
<a name="l00179"></a><a class="code" href="structcvmx__tim__kernel__t.html">00179</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00180"></a>00180 {
<a name="l00181"></a><a class="code" href="structcvmx__tim__kernel__t.html#aa9c534a2a13bfad9c3fc9904947a25f0">00181</a>     uint64_t    bucket;
<a name="l00182"></a><a class="code" href="structcvmx__tim__kernel__t.html#a9766bc66125c42dd3df8e7346da4fc6b">00182</a>     uint64_t    tick_cycles;
<a name="l00183"></a><a class="code" href="structcvmx__tim__kernel__t.html#a45fa2432b7bbf2db271b935dde987ef5">00183</a>     uint64_t    start_time;
<a name="l00184"></a>00184 <span class="preprocessor">#if __BYTE_ORDER == __BIG_ENDIAN</span>
<a name="l00185"></a><a class="code" href="structcvmx__tim__kernel__t.html#ac3f027478c404e8b42bade8c72daf7b9">00185</a> <span class="preprocessor"></span>    uint32_t    bucket_shift;
<a name="l00186"></a><a class="code" href="structcvmx__tim__kernel__t.html#a01059df32194cb77ee73145a5f3d2703">00186</a>     uint32_t    num_buckets;
<a name="l00187"></a><a class="code" href="structcvmx__tim__kernel__t.html#a51735bf48c2d99ad873da18802e115da">00187</a>     uint32_t    max_ticks;
<a name="l00188"></a><a class="code" href="structcvmx__tim__kernel__t.html#af83bd92ca962db8c99c85bcd23ad675f">00188</a>     uint32_t    num_rings;
<a name="l00189"></a>00189 <span class="preprocessor">#else</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>    uint32_t    num_buckets;
<a name="l00191"></a>00191     uint32_t    bucket_shift;
<a name="l00192"></a>00192     uint32_t    num_rings;
<a name="l00193"></a>00193     uint32_t    max_ticks;
<a name="l00194"></a>00194 <span class="preprocessor">#endif</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>} <a class="code" href="structcvmx__tim__kernel__t.html" title="Structure representing an individual timer.">cvmx_tim_kernel_t</a>;
<a name="l00196"></a>00196 <span class="comment"></span>
<a name="l00197"></a>00197 <span class="comment">/**</span>
<a name="l00198"></a>00198 <span class="comment"> * Structure used to pass timer information to the Linux kernel to schedule</span>
<a name="l00199"></a>00199 <span class="comment"> * wqe&apos;s.</span>
<a name="l00200"></a>00200 <span class="comment"> *</span>
<a name="l00201"></a>00201 <span class="comment"> * This structure must be kept in sync with the one in </span>
<a name="l00202"></a>00202 <span class="comment"> * linux/arch/mips/cavium-octeon/cavium.c.</span>
<a name="l00203"></a>00203 <span class="comment"> * @INTERNAL</span>
<a name="l00204"></a>00204 <span class="comment"> */</span>
<a name="l00205"></a><a class="code" href="structcvmx__tim__info__t.html">00205</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00206"></a>00206 {
<a name="l00207"></a><a class="code" href="structcvmx__tim__info__t.html#a1e67e909938bc591fd2d68181ce79261">00207</a>     uint64_t        wqe;
<a name="l00208"></a><a class="code" href="structcvmx__tim__info__t.html#a2cb6dbf0f76baf41feeeba7e9ead99ab">00208</a>     uint64_t        ticks_from_now;
<a name="l00209"></a>00209 <span class="preprocessor">#if __BYTE_ORDER == __BIG_ENDIAN</span>
<a name="l00210"></a><a class="code" href="structcvmx__tim__info__t.html#afeeab34b525a18c93cf253a4a947adac">00210</a> <span class="preprocessor"></span>    uint32_t        timer_pool;
<a name="l00211"></a><a class="code" href="structcvmx__tim__info__t.html#ab3c504ab41d05cd952af21dc97527bbe">00211</a>     uint32_t        timer_pool_size;
<a name="l00212"></a>00212 <span class="preprocessor">#else</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>    uint32_t        timer_pool_size;
<a name="l00214"></a>00214     uint32_t        timer_pool;
<a name="l00215"></a>00215 <span class="preprocessor">#endif</span>
<a name="l00216"></a><a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">00216</a> <span class="preprocessor"></span>    <a class="code" href="structcvmx__tim__kernel__t.html" title="Structure representing an individual timer.">cvmx_tim_kernel_t</a>   <a class="code" href="cvmx-tim_8c.html#a20e2f026fe54804779b987c6097d1bea" title="Global structure holding the state of all timers.">cvmx_tim</a>;
<a name="l00217"></a>00217 } <a class="code" href="structcvmx__tim__info__t.html" title="Structure used to pass timer information to the Linux kernel to schedule wqe&amp;#39;s...">cvmx_tim_info_t</a>;
<a name="l00218"></a>00218 <span class="comment"></span>
<a name="l00219"></a>00219 <span class="comment">/**</span>
<a name="l00220"></a>00220 <span class="comment"> * Structure used to store state information needed to delete</span>
<a name="l00221"></a>00221 <span class="comment"> * an already scheduled timer entry. An instance of this</span>
<a name="l00222"></a>00222 <span class="comment"> * structure must be passed to cvmx_tim_add_entry in order</span>
<a name="l00223"></a>00223 <span class="comment"> * to be able to delete an entry later with</span>
<a name="l00224"></a>00224 <span class="comment"> * cvmx_tim_delete_entry.</span>
<a name="l00225"></a>00225 <span class="comment"> *</span>
<a name="l00226"></a>00226 <span class="comment"> * NOTE: This structure should be considered opaque by the application,</span>
<a name="l00227"></a>00227 <span class="comment"> * and the application should not access its members</span>
<a name="l00228"></a>00228 <span class="comment"> */</span>
<a name="l00229"></a><a class="code" href="structcvmx__tim__delete__t.html">00229</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00230"></a>00230     uint64_t commit_cycles;<span class="comment"></span>
<a name="l00231"></a><a class="code" href="structcvmx__tim__delete__t.html#adfb48c0a4e2c83c7ca243ff4116ddfa4">00231</a> <span class="comment">                    /**&lt; After this time the timer can&apos;t be changed */</span>
<a name="l00232"></a>00232     uint64_t *timer_entry_ptr;<span class="comment"></span>
<a name="l00233"></a><a class="code" href="structcvmx__tim__delete__t.html#a2ed9c072b995d7aaf2c5e41829257221">00233</a> <span class="comment">                    /**&lt; Where the work entry is. Zero this</span>
<a name="l00234"></a>00234 <span class="comment">                                            location to delete the entry */</span>
<a name="l00235"></a>00235 } <a class="code" href="structcvmx__tim__delete__t.html" title="Structure used to store state information needed to delete an already scheduled timer...">cvmx_tim_delete_t</a>;
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="structcvmx__tim__config__t.html">00237</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00238"></a>00238 {
<a name="l00239"></a><a class="code" href="structcvmx__tim__config__t.html#acfb921abb5533ef655bdb28b0c48e3f8">00239</a>     <a class="code" href="structcvmx__fpa__pool__config.html" title="Structure to store FPA pool configuration parameters.">cvmx_fpa_pool_config_t</a> timer_pool;  <span class="comment">/* pool==aura on CN78XX */</span>
<a name="l00240"></a>00240 }<a class="code" href="structcvmx__tim__config__t.html">cvmx_tim_config_t</a>;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="keyword">extern</span> <a class="code" href="structcvmx__tim__config__t.html">cvmx_tim_config_t</a> *<a class="code" href="cvmx-tim_8c.html#a7727c6be53794d254d6146676c70a2fa" title="Global structure holding the state of all timers.">timer_config</a>;
<a name="l00243"></a>00243 <span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="cvmx-tim_8c.html#aea0bf5e7ca64e35fae2cff93f607cdac">tim_named_block_name</a>[];
<a name="l00244"></a>00244 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="cvmx-tim_8c.html#a94d928d262ad925901638dce9bbc4633">cvmx_create_tim_named_block_once</a>(<span class="keywordtype">void</span>);
<a name="l00245"></a>00245 <span class="comment"></span>
<a name="l00246"></a>00246 <span class="comment">/**</span>
<a name="l00247"></a>00247 <span class="comment"> * Gets the fpa pool number of timer pool</span>
<a name="l00248"></a>00248 <span class="comment"> */</span>
<a name="l00249"></a><a class="code" href="cvmx-tim_8h.html#afc956590260aa093fbf3cde74b28ba8c">00249</a> <span class="keyword">static</span> <span class="keyword">inline</span> int64_t <a class="code" href="cvmx-tim_8h.html#afc956590260aa093fbf3cde74b28ba8c" title="Gets the fpa pool number of timer pool.">cvmx_fpa_get_timer_pool</a>(<span class="keywordtype">void</span>)
<a name="l00250"></a>00250 {
<a name="l00251"></a>00251     <a class="code" href="cvmx-tim_8c.html#a94d928d262ad925901638dce9bbc4633">cvmx_create_tim_named_block_once</a>();
<a name="l00252"></a>00252     <span class="keywordflow">return</span> (timer_config-&gt;<a class="code" href="structcvmx__tim__config__t.html#acfb921abb5533ef655bdb28b0c48e3f8">timer_pool</a>.<a class="code" href="structcvmx__fpa__pool__config.html#aaff187768110c50b9320ea092636650d">pool_num</a>);
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 <span class="comment"></span>
<a name="l00255"></a>00255 <span class="comment">/**</span>
<a name="l00256"></a>00256 <span class="comment"> * Gets the buffer size of timer pool</span>
<a name="l00257"></a>00257 <span class="comment"> */</span>
<a name="l00258"></a><a class="code" href="cvmx-tim_8h.html#af97aaf0d6b53a7a0621e3ae3f5d5044e">00258</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint64_t <a class="code" href="cvmx-tim_8h.html#af97aaf0d6b53a7a0621e3ae3f5d5044e" title="Gets the buffer size of timer pool.">cvmx_fpa_get_timer_pool_block_size</a>(<span class="keywordtype">void</span>)
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260     <a class="code" href="cvmx-tim_8c.html#a94d928d262ad925901638dce9bbc4633">cvmx_create_tim_named_block_once</a>();
<a name="l00261"></a>00261     <span class="keywordflow">return</span> (timer_config-&gt;<a class="code" href="structcvmx__tim__config__t.html#acfb921abb5533ef655bdb28b0c48e3f8">timer_pool</a>.<a class="code" href="structcvmx__fpa__pool__config.html#a34738799e44f20102d117b033811ac3e">buffer_size</a>);
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 <span class="comment"></span>
<a name="l00264"></a>00264 <span class="comment">/**</span>
<a name="l00265"></a>00265 <span class="comment"> * Gets the buffer count of timer pool</span>
<a name="l00266"></a>00266 <span class="comment"> */</span>
<a name="l00267"></a><a class="code" href="cvmx-tim_8h.html#aa0e5117cf7397aba30fd6fc6890a76cf">00267</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint64_t <a class="code" href="cvmx-tim_8h.html#aa0e5117cf7397aba30fd6fc6890a76cf" title="Gets the buffer count of timer pool.">cvmx_fpa_get_timer_pool_buffer_count</a>(<span class="keywordtype">void</span>)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <a class="code" href="cvmx-tim_8c.html#a94d928d262ad925901638dce9bbc4633">cvmx_create_tim_named_block_once</a>();
<a name="l00270"></a>00270     <span class="keywordflow">return</span> (timer_config-&gt;<a class="code" href="structcvmx__tim__config__t.html#acfb921abb5533ef655bdb28b0c48e3f8">timer_pool</a>.<a class="code" href="structcvmx__fpa__pool__config.html#a833e0523ec2cd123425307e380166b08">buffer_count</a>);
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 <span class="comment"></span>
<a name="l00273"></a>00273 <span class="comment">/**</span>
<a name="l00274"></a>00274 <span class="comment"> * Sets the internal FPA pool data structure for timer pool.</span>
<a name="l00275"></a>00275 <span class="comment"> * @param pool  fpa pool number to use</span>
<a name="l00276"></a>00276 <span class="comment"> * @param buffer_size   buffer size of pool</span>
<a name="l00277"></a>00277 <span class="comment"> * @param buffer_count  number of buffers to allocate to pool</span>
<a name="l00278"></a>00278 <span class="comment"> */</span>
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="keywordtype">void</span> <a class="code" href="cvmx-tim_8c.html#adcb1bfa1cff80d7a10d43c8a79394002" title="Sets the internal FPA pool data structure for timer pool.">cvmx_tim_set_fpa_pool_config</a>(int64_t pool, uint64_t buffer_size,
<a name="l00281"></a>00281                       uint64_t buffer_count);
<a name="l00282"></a>00282 <span class="comment"></span>
<a name="l00283"></a>00283 <span class="comment">/**</span>
<a name="l00284"></a>00284 <span class="comment"> * Gets the internal FPA pool data structure for timer pool.</span>
<a name="l00285"></a>00285 <span class="comment"> * @param timer_pool pointer to timer fpa pool structure where data gets copied</span>
<a name="l00286"></a>00286 <span class="comment"> */</span>
<a name="l00287"></a>00287 <span class="keywordtype">void</span> <a class="code" href="cvmx-tim_8c.html#a41fc67f7c2111f39c0cfe7249281264b" title="Gets the internal FPA pool data structure for timer pool.">cvmx_tim_get_fpa_pool_config</a>(<a class="code" href="structcvmx__fpa__pool__config.html" title="Structure to store FPA pool configuration parameters.">cvmx_fpa_pool_config_t</a> *timer_pool);
<a name="l00288"></a>00288 <span class="comment"></span>
<a name="l00289"></a>00289 <span class="comment">/**</span>
<a name="l00290"></a>00290 <span class="comment"> * Global structure holding the state of all timers.</span>
<a name="l00291"></a>00291 <span class="comment"> */</span>
<a name="l00292"></a>00292 <a class="code" href="cvmx-platform_8h.html#a845de1642e5d22d87bd00b994bdcd82e">CVMX_SHARED</a> <span class="keyword">extern</span> <a class="code" href="structcvmx__tim__t.html" title="Structure representing an individual timer.">cvmx_tim_t</a> *<a class="code" href="cvmx-tim_8c.html#a20e2f026fe54804779b987c6097d1bea" title="Global structure holding the state of all timers.">cvmx_tim</a>;
<a name="l00293"></a>00293 <span class="comment"></span>
<a name="l00294"></a>00294 <span class="comment">/**</span>
<a name="l00295"></a>00295 <span class="comment"> * Setup a timer for use. Must be called before the timer</span>
<a name="l00296"></a>00296 <span class="comment"> * can be used.</span>
<a name="l00297"></a>00297 <span class="comment"> *</span>
<a name="l00298"></a>00298 <span class="comment"> * @param tick      Time between each bucket in microseconds. This must not be</span>
<a name="l00299"></a>00299 <span class="comment"> *                  smaller than 1024/(clock frequency in MHz).</span>
<a name="l00300"></a>00300 <span class="comment"> * @param max_ticks The maximum number of ticks the timer must be able</span>
<a name="l00301"></a>00301 <span class="comment"> *                  to schedule in the future. There are guaranteed to be enough</span>
<a name="l00302"></a>00302 <span class="comment"> *                  timer buckets such that:</span>
<a name="l00303"></a>00303 <span class="comment"> *                  number of buckets &gt;= max_ticks.</span>
<a name="l00304"></a>00304 <span class="comment"> * @return Zero on success. Negative on error. Failures are possible</span>
<a name="l00305"></a>00305 <span class="comment"> *         if the number of buckets needed is too large or memory</span>
<a name="l00306"></a>00306 <span class="comment"> *         allocation fails for creating the buckets.</span>
<a name="l00307"></a>00307 <span class="comment"> */</span>
<a name="l00308"></a>00308 <span class="keywordtype">int</span> <a class="code" href="cvmx-tim_8c.html#ac07d6a9236b4809b8ee56ae3efc811c4" title="Setup a timer for use.">cvmx_tim_setup</a>(uint64_t tick, uint64_t max_ticks);
<a name="l00309"></a>00309 <span class="comment"></span>
<a name="l00310"></a>00310 <span class="comment">/**</span>
<a name="l00311"></a>00311 <span class="comment"> * Start the hardware timer processing</span>
<a name="l00312"></a>00312 <span class="comment"> */</span>
<a name="l00313"></a>00313 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="cvmx-tim_8c.html#a65b230b7a48c995d2585c356c25a9490" title="Start the hardware timer processing.">cvmx_tim_start</a>(<span class="keywordtype">void</span>);
<a name="l00314"></a>00314 <span class="comment"></span>
<a name="l00315"></a>00315 <span class="comment">/**</span>
<a name="l00316"></a>00316 <span class="comment"> * Stop the hardware timer processing. Timers stay configured.</span>
<a name="l00317"></a>00317 <span class="comment"> */</span>
<a name="l00318"></a>00318 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="cvmx-tim_8c.html#ac769622414ae3622d884a97748146413" title="Stop the hardware timer processing.">cvmx_tim_stop</a>(<span class="keywordtype">void</span>);
<a name="l00319"></a>00319 <span class="comment"></span>
<a name="l00320"></a>00320 <span class="comment">/**</span>
<a name="l00321"></a>00321 <span class="comment"> * Stop the timer. After this the timer must be setup again</span>
<a name="l00322"></a>00322 <span class="comment"> * before use.</span>
<a name="l00323"></a>00323 <span class="comment"> */</span>
<a name="l00324"></a>00324 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="cvmx-tim_8c.html#a7eb18ce633da47d952026a3a2ed0e691" title="Stop the timer.">cvmx_tim_shutdown</a>(<span class="keywordtype">void</span>);
<a name="l00325"></a>00325 <span class="comment"></span>
<a name="l00326"></a>00326 <span class="comment">/**</span>
<a name="l00327"></a>00327 <span class="comment"> * Store work queue entry into timer chunk</span>
<a name="l00328"></a>00328 <span class="comment"> * @INTERNAL</span>
<a name="l00329"></a>00329 <span class="comment"> */</span>
<a name="l00330"></a><a class="code" href="cvmx-tim_8h.html#a373de37dafc284e011397f1a7ef18c9e">00330</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvmx-tim_8h.html#a373de37dafc284e011397f1a7ef18c9e" title="Store work queue entry into timer chunk Internal use function.">cvmx_tim_wqe_store</a>(<span class="keyword">volatile</span> uint64_t *ptr, <a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *wqe)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332         <span class="keywordflow">if</span>(wqe == NULL)
<a name="l00333"></a>00333             *ptr = 0<a class="code" href="cvmx-usbd_8c.html#aaecc43af33d06f506a9509a7eb6d814f">ULL</a>;
<a name="l00334"></a>00334         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a1deef61f201401bab191e2ab4a1d05a6">OCTEON_CN78XX</a>) ||
<a name="l00335"></a>00335                  <a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a3018e90a8278d961f5f829b40c36b0ae">OCTEON_CN73XX</a>) ||
<a name="l00336"></a>00336                  <a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a40a5b22bfd5e1eefdaa689463f9a8d30">OCTEON_CNF75XX</a>)) {
<a name="l00337"></a>00337             <span class="comment">/* TIM_MEM_S structure in chunk */</span>
<a name="l00338"></a>00338             *ptr =
<a name="l00339"></a>00339                 (uint64_t)<a class="code" href="cvmx-access_8h.html#a76ed79b4650d01f82f1f517be07fe7c5" title="Convert a memory pointer (void*) into a hardware compatable memory address (uint64_t)...">cvmx_ptr_to_phys</a>(wqe) |
<a name="l00340"></a>00340                 (uint64_t)<a class="code" href="cvmx-wqe_8h.html#a7bc45c44e9da81a8949ea565dfbe0e14">cvmx_wqe_get_xgrp</a>(wqe) &lt;&lt; 52 |
<a name="l00341"></a>00341                 (uint64_t)<a class="code" href="cvmx-wqe_8h.html#a5f37b821beefb73dabf798425999c76e">cvmx_wqe_get_tt</a>(wqe) &lt;&lt; 50;
<a name="l00342"></a>00342         } <span class="keywordflow">else</span> {
<a name="l00343"></a>00343             <span class="comment">/* pointer to wqe address in timer chunk */</span>
<a name="l00344"></a>00344             *ptr = <a class="code" href="cvmx-access_8h.html#a76ed79b4650d01f82f1f517be07fe7c5" title="Convert a memory pointer (void*) into a hardware compatable memory address (uint64_t)...">cvmx_ptr_to_phys</a>(wqe);
<a name="l00345"></a>00345         }
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 <span class="comment"></span>
<a name="l00348"></a>00348 <span class="comment">/**</span>
<a name="l00349"></a>00349 <span class="comment"> * Add a work queue entry to the timer.</span>
<a name="l00350"></a>00350 <span class="comment"> *</span>
<a name="l00351"></a>00351 <span class="comment"> * @param work_entry Work queue entry to add.</span>
<a name="l00352"></a>00352 <span class="comment"> * @param ticks_from_now</span>
<a name="l00353"></a>00353 <span class="comment"> * @param delete_info</span>
<a name="l00354"></a>00354 <span class="comment"> *                   Optional pointer where to store information needed to</span>
<a name="l00355"></a>00355 <span class="comment"> *                   delete the timer entry. If non NULL information needed</span>
<a name="l00356"></a>00356 <span class="comment"> *                   to delete the timer entry before it fires is stored here.</span>
<a name="l00357"></a>00357 <span class="comment"> *                   If you don&apos;t need to be able to delete the timer, pass</span>
<a name="l00358"></a>00358 <span class="comment"> *                   NULL.</span>
<a name="l00359"></a>00359 <span class="comment"> * @return Result return code</span>
<a name="l00360"></a>00360 <span class="comment"> */</span>
<a name="l00361"></a><a class="code" href="cvmx-tim_8h.html#ae17b378539c0585c6bbc8e27bf88568b">00361</a> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04b">cvmx_tim_status_t</a> <a class="code" href="cvmx-tim_8h.html#ae17b378539c0585c6bbc8e27bf88568b" title="Add a work queue entry to the timer.">cvmx_tim_add_entry</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> * work_entry, uint64_t ticks_from_now, <a class="code" href="structcvmx__tim__delete__t.html" title="Structure used to store state information needed to delete an already scheduled timer...">cvmx_tim_delete_t</a> * delete_info)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363 <span class="preprocessor">#ifdef CVMX_BUILD_FOR_LINUX_USER</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span>    <a class="code" href="structcvmx__tim__info__t.html" title="Structure used to pass timer information to the Linux kernel to schedule wqe&amp;#39;s...">cvmx_tim_info_t</a> tim_info;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a1e67e909938bc591fd2d68181ce79261">wqe</a> = <a class="code" href="cvmx-access_8h.html#a76ed79b4650d01f82f1f517be07fe7c5" title="Convert a memory pointer (void*) into a hardware compatable memory address (uint64_t)...">cvmx_ptr_to_phys</a>(work_entry);
<a name="l00367"></a>00367     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a2cb6dbf0f76baf41feeeba7e9ead99ab">ticks_from_now</a> = ticks_from_now;
<a name="l00368"></a>00368     tim_info.<a class="code" href="structcvmx__tim__info__t.html#afeeab34b525a18c93cf253a4a947adac">timer_pool</a> = (uint32_t)<a class="code" href="cvmx-tim_8h.html#afc956590260aa093fbf3cde74b28ba8c" title="Gets the fpa pool number of timer pool.">cvmx_fpa_get_timer_pool</a>();
<a name="l00369"></a>00369     tim_info.<a class="code" href="structcvmx__tim__info__t.html#ab3c504ab41d05cd952af21dc97527bbe">timer_pool_size</a> =
<a name="l00370"></a>00370         (uint32_t)<a class="code" href="cvmx-tim_8h.html#af97aaf0d6b53a7a0621e3ae3f5d5044e" title="Gets the buffer size of timer pool.">cvmx_fpa_get_timer_pool_block_size</a>();
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">cvmx_tim</a>.<a class="code" href="structcvmx__tim__kernel__t.html#aa9c534a2a13bfad9c3fc9904947a25f0">bucket</a> = <a class="code" href="cvmx-utils_8h.html#ae7cbf89dbb7504367392356eefc926da">CAST64</a>(cvmx_tim-&gt;bucket);
<a name="l00373"></a>00373     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">cvmx_tim</a>.<a class="code" href="structcvmx__tim__kernel__t.html#a9766bc66125c42dd3df8e7346da4fc6b">tick_cycles</a> = cvmx_tim-&gt;tick_cycles;
<a name="l00374"></a>00374     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">cvmx_tim</a>.<a class="code" href="structcvmx__tim__kernel__t.html#a45fa2432b7bbf2db271b935dde987ef5">start_time</a> = cvmx_tim-&gt;start_time;
<a name="l00375"></a>00375     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">cvmx_tim</a>.<a class="code" href="structcvmx__tim__kernel__t.html#ac3f027478c404e8b42bade8c72daf7b9">bucket_shift</a> = cvmx_tim-&gt;bucket_shift;
<a name="l00376"></a>00376     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">cvmx_tim</a>.<a class="code" href="structcvmx__tim__kernel__t.html#a01059df32194cb77ee73145a5f3d2703">num_buckets</a> = cvmx_tim-&gt;num_buckets;
<a name="l00377"></a>00377     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">cvmx_tim</a>.<a class="code" href="structcvmx__tim__kernel__t.html#a51735bf48c2d99ad873da18802e115da">max_ticks</a> = cvmx_tim-&gt;max_ticks;
<a name="l00378"></a>00378     tim_info.<a class="code" href="structcvmx__tim__info__t.html#a00e764dcb45d7021eb570f9051299cb0">cvmx_tim</a>.<a class="code" href="structcvmx__tim__kernel__t.html#af83bd92ca962db8c99c85bcd23ad675f">num_rings</a> = cvmx_tim-&gt;num_rings;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">return</span> (<a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04b">cvmx_tim_status_t</a>)sysmips(<a class="code" href="cvmx-tim_8h.html#a7a6976e5763003410ab18a1213276b4b">MIPS_CAVIUM_ARM_TIMER</a>, &amp;tim_info, delete_info);
<a name="l00381"></a>00381 <span class="preprocessor">#else</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span>    <a class="code" href="structcvmx__tim__bucket__entry__t.html" title="Each timer contains an array of buckets.">cvmx_tim_bucket_entry_t</a> *work_bucket_ptr;
<a name="l00383"></a>00383     uint64_t work_bucket;
<a name="l00384"></a>00384     uint64_t entries_per_chunk;
<a name="l00385"></a>00385     <span class="keyword">volatile</span> <span class="keywordtype">void</span> * tim_entry_ptr = NULL;
<a name="l00386"></a>00386     <span class="keywordtype">int</span> timer_pool = (int)<a class="code" href="cvmx-tim_8h.html#afc956590260aa093fbf3cde74b28ba8c" title="Gets the fpa pool number of timer pool.">cvmx_fpa_get_timer_pool</a>();
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="keyword">const</span> uint64_t cycles = <a class="code" href="cvmx-clock_8h.html#adfe1c5a79a6c19685293c0db6dab3322" title="Get cycle count based on the clock type.">cvmx_clock_get_count</a>(<a class="code" href="cvmx-clock_8h.html#a72edd1cfc6601809fea7ce5ce6c05965a8321dcbca3fb01c74c6e2fafa9ba4dd8" title="Alias for CVMX_CLOCK_SCLK.">CVMX_CLOCK_TIM</a>);   <span class="comment">/* Get our reference time early for accuracy */</span>
<a name="l00389"></a>00389     <span class="keyword">const</span> uint64_t core_num = <a class="code" href="cvmx-coremask_8h.html#a921674fae09cb6a5f34a3d953165cd0b">cvmx_get_core_num</a>();  <span class="comment">/* One timer per processor, so use this to select */</span>
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <span class="comment">/* Make sure the specified time won&apos;t wrap our bucket list */</span>
<a name="l00392"></a>00392     <span class="keywordflow">if</span> (<a class="code" href="cvmx-utils_8h.html#a3923c29d957d55949021630348297e03">cvmx_unlikely</a>(ticks_from_now &gt; cvmx_tim-&gt;max_ticks)) {
<a name="l00393"></a>00393         <a class="code" href="cvmx-utils_8h.html#a50112e4e118a749dcf244ccafcdc37ba">cvmx_dprintf</a>(<span class="stringliteral">&quot;cvmx_tim_add_entry: Tried to schedule work too far away.\n&quot;</span>);
<a name="l00394"></a>00394         <span class="keywordflow">return</span> <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04bade80cb02a77907646a5697edae049f93">CVMX_TIM_STATUS_TOO_FAR_AWAY</a>;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="comment">/* Since we have no way to synchronize, we can&apos;t update a timer that is</span>
<a name="l00398"></a>00398 <span class="comment">       being used by the hardware. Two buckets forward should be safe */</span>
<a name="l00399"></a>00399     <span class="keywordflow">if</span> (ticks_from_now &lt; 2) {
<a name="l00400"></a>00400         <a class="code" href="cvmx-utils_8h.html#a50112e4e118a749dcf244ccafcdc37ba">cvmx_dprintf</a>(<span class="stringliteral">&quot;cvmx_tim_add_entry: Tried to schedule work too soon. Delaying it.\n&quot;</span>);
<a name="l00401"></a>00401         ticks_from_now = 2;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/* Get the bucket this work queue entry should be in. Remember the bucket</span>
<a name="l00405"></a>00405 <span class="comment">       array is circular */</span>
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (<a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a1deef61f201401bab191e2ab4a1d05a6">OCTEON_CN78XX</a>) ||
<a name="l00407"></a>00407         <a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a3018e90a8278d961f5f829b40c36b0ae">OCTEON_CN73XX</a>) ||
<a name="l00408"></a>00408         <a class="code" href="octeon-model_8h.html#a9234ac9e9f35fafd7fe5eedd37c9b552">OCTEON_IS_MODEL</a>(<a class="code" href="octeon-model_8h.html#a40a5b22bfd5e1eefdaa689463f9a8d30">OCTEON_CNF75XX</a>)) {
<a name="l00409"></a>00409         <a class="code" href="unioncvmx__tim__ringx__ctl1.html" title="cvmx_tim_ring::_ctl1">cvmx_tim_ringx_ctl1_t</a> ring_ctl1;
<a name="l00410"></a>00410         <span class="keywordtype">unsigned</span> node, ring_id;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         ring_id = core_num;
<a name="l00413"></a>00413         node = <a class="code" href="cvmx-access_8h.html#a9d019c6d93cab6e1f83e62029631b017" title="Number of the node on which the program is currently running.">cvmx_get_node_num</a>();
<a name="l00414"></a>00414 
<a name="l00415"></a>00415         ring_ctl1.<a class="code" href="unioncvmx__tim__ringx__ctl1.html#a2d36bc88cb89f7ab8949816f70ad6dd0">u64</a> =
<a name="l00416"></a>00416             <a class="code" href="cvmx-access_8h.html#a2b50ee7713f0744b1fef03cfa4c1b670">cvmx_read_csr_node</a>(node, <a class="code" href="cvmx-tim-defs_8h.html#ae9da67d36e277e551d3dcc18795f0894">CVMX_TIM_RINGX_CTL1</a>(ring_id));
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         work_bucket = ring_ctl1.<a class="code" href="unioncvmx__tim__ringx__ctl1.html#ac2ad54d762ddfb13ef7e64965b9820d3">cn78xx</a>.bucket;
<a name="l00419"></a>00419         work_bucket += ticks_from_now;
<a name="l00420"></a>00420     } <span class="keywordflow">else</span> {
<a name="l00421"></a>00421         <span class="comment">/* FIXME: this version needs an explanation */</span>
<a name="l00422"></a>00422     work_bucket = (((ticks_from_now * cvmx_tim-&gt;tick_cycles) + cycles - cvmx_tim-&gt;start_time)
<a name="l00423"></a>00423                &gt;&gt; cvmx_tim-&gt;bucket_shift);
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     work_bucket_ptr = cvmx_tim-&gt;bucket + core_num * cvmx_tim-&gt;num_buckets + (work_bucket &amp; (cvmx_tim-&gt;num_buckets - 1));
<a name="l00427"></a>00427     entries_per_chunk = (<a class="code" href="cvmx-tim_8h.html#af97aaf0d6b53a7a0621e3ae3f5d5044e" title="Gets the buffer size of timer pool.">cvmx_fpa_get_timer_pool_block_size</a>() / 8 - 1);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="comment">/* Check if we have room to add this entry into the existing list */</span>
<a name="l00430"></a>00430     <span class="keywordflow">if</span> (<a class="code" href="cvmx-utils_8h.html#acb99b2656f7f63800bed44de322b27ee">cvmx_likely</a>(work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a10b1638f2e9401392ba35f4b4da08769" title="Zeroed by HW after traversing list.">chunk_remainder</a>) )
<a name="l00431"></a>00431     {
<a name="l00432"></a>00432         <span class="keywordtype">unsigned</span> ent = entries_per_chunk -
<a name="l00433"></a>00433             work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a10b1638f2e9401392ba35f4b4da08769" title="Zeroed by HW after traversing list.">chunk_remainder</a>;
<a name="l00434"></a>00434         tim_entry_ptr = &amp;(work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a5857db1bb4ee4b265f8c30dd884c28d9">last_chunk</a>-&gt;<a class="code" href="structcvmx__tim__entry__chunk.html#ab83f18c163b4d12fa9eff96b1e7e3491">entries</a>[ent]);
<a name="l00435"></a>00435         <span class="comment">/* Adding the work entry to the end of the existing list */</span>
<a name="l00436"></a>00436         work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a10b1638f2e9401392ba35f4b4da08769" title="Zeroed by HW after traversing list.">chunk_remainder</a>--;
<a name="l00437"></a>00437         work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a50fe96f8f22f082c60b9a7500c5823ed" title="Zeroed by HW after traversing list.">num_entries</a>++;
<a name="l00438"></a>00438         <a class="code" href="cvmx-tim_8h.html#a373de37dafc284e011397f1a7ef18c9e" title="Store work queue entry into timer chunk Internal use function.">cvmx_tim_wqe_store</a>((<span class="keyword">volatile</span> uint64_t *)tim_entry_ptr, work_entry);
<a name="l00439"></a>00439     } 
<a name="l00440"></a>00440     <span class="keywordflow">else</span> 
<a name="l00441"></a>00441     {
<a name="l00442"></a>00442         <span class="comment">/* Current list is either completely empty or completely full. We need</span>
<a name="l00443"></a>00443 <span class="comment">           to allocate a new chunk for storing this work entry */</span>
<a name="l00444"></a>00444         <a class="code" href="structcvmx__tim__entry__chunk.html" title="Each timer bucket contains a list of work queue entries to schedule when the timer...">cvmx_tim_entry_chunk_t</a> *new_chunk = (<a class="code" href="structcvmx__tim__entry__chunk.html" title="Each timer bucket contains a list of work queue entries to schedule when the timer...">cvmx_tim_entry_chunk_t</a> *) <a class="code" href="cvmx-fpa_8h.html#a862613eb44a7557a5daae94a2c1406c7" title="Get a new block from the FPA.">cvmx_fpa_alloc</a>(timer_pool);
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (<a class="code" href="cvmx-utils_8h.html#a3923c29d957d55949021630348297e03">cvmx_unlikely</a>(new_chunk == NULL)) {
<a name="l00446"></a>00446             <a class="code" href="cvmx-utils_8h.html#a50112e4e118a749dcf244ccafcdc37ba">cvmx_dprintf</a>(<span class="stringliteral">&quot;cvmx_tim_add_entry: Failed to allocate memory for new chunk.\n&quot;</span>);
<a name="l00447"></a>00447             <span class="keywordflow">return</span> <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04baa8396391c0d8e26ec7a68e1e32732ed5">CVMX_TIM_STATUS_NO_MEMORY</a>;
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="comment">/* Does a chunk currently exist? We have to check num_entries since</span>
<a name="l00451"></a>00451 <span class="comment">           the hardware doesn&apos;t NULL out the chunk pointers on free */</span>
<a name="l00452"></a>00452         <span class="keywordflow">if</span> (work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a50fe96f8f22f082c60b9a7500c5823ed" title="Zeroed by HW after traversing list.">num_entries</a>) 
<a name="l00453"></a>00453         {
<a name="l00454"></a>00454             <span class="comment">/* This chunk must be appended to an existing list by putting</span>
<a name="l00455"></a>00455 <span class="comment">             ** its address in the last spot of the existing chunk. */</span>
<a name="l00456"></a>00456             work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a5857db1bb4ee4b265f8c30dd884c28d9">last_chunk</a>-&gt;<a class="code" href="structcvmx__tim__entry__chunk.html#ab83f18c163b4d12fa9eff96b1e7e3491">entries</a>[entries_per_chunk] = <a class="code" href="cvmx-access_8h.html#a76ed79b4650d01f82f1f517be07fe7c5" title="Convert a memory pointer (void*) into a hardware compatable memory address (uint64_t)...">cvmx_ptr_to_phys</a>(new_chunk);
<a name="l00457"></a>00457             work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a50fe96f8f22f082c60b9a7500c5823ed" title="Zeroed by HW after traversing list.">num_entries</a>++;
<a name="l00458"></a>00458         } 
<a name="l00459"></a>00459         <span class="keywordflow">else</span> 
<a name="l00460"></a>00460         {
<a name="l00461"></a>00461             <span class="comment">/* This is the very first chunk. Add it */</span>
<a name="l00462"></a>00462             work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a926a3397881d680bb429ff0e7aeeabbc">first_chunk_addr</a> = <a class="code" href="cvmx-access_8h.html#a76ed79b4650d01f82f1f517be07fe7c5" title="Convert a memory pointer (void*) into a hardware compatable memory address (uint64_t)...">cvmx_ptr_to_phys</a>(new_chunk);
<a name="l00463"></a>00463             work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a50fe96f8f22f082c60b9a7500c5823ed" title="Zeroed by HW after traversing list.">num_entries</a> = 1;
<a name="l00464"></a>00464         }
<a name="l00465"></a>00465         work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a5857db1bb4ee4b265f8c30dd884c28d9">last_chunk</a> = new_chunk;
<a name="l00466"></a>00466         work_bucket_ptr-&gt;<a class="code" href="structcvmx__tim__bucket__entry__t.html#a10b1638f2e9401392ba35f4b4da08769" title="Zeroed by HW after traversing list.">chunk_remainder</a> = entries_per_chunk - 1;
<a name="l00467"></a>00467         tim_entry_ptr =&amp;(new_chunk-&gt;<a class="code" href="structcvmx__tim__entry__chunk.html#ab83f18c163b4d12fa9eff96b1e7e3491">entries</a>[0]);
<a name="l00468"></a>00468         <a class="code" href="cvmx-tim_8h.html#a373de37dafc284e011397f1a7ef18c9e" title="Store work queue entry into timer chunk Internal use function.">cvmx_tim_wqe_store</a>( (<span class="keyword">volatile</span> uint64_t *)tim_entry_ptr, work_entry);
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 <span class="preprocessor">#if TIM_DEBUG</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span>    <a class="code" href="cvmx-utils_8h.html#a50112e4e118a749dcf244ccafcdc37ba">cvmx_dprintf</a>(<span class="stringliteral">&quot;INFO: %s: core_num = %lu, ticks_from_now = %lu, &quot;</span>
<a name="l00473"></a>00473         <span class="stringliteral">&quot;bucket = %lu, bucket_ptr = %p wqe=%p(%#x)\n&quot;</span>,
<a name="l00474"></a>00474         __func__,
<a name="l00475"></a>00475         core_num, ticks_from_now, work_bucket,
<a name="l00476"></a>00476         work_bucket_ptr, work_entry,
<a name="l00477"></a>00477         (<span class="keywordtype">unsigned</span>)<a class="code" href="cvmx-access_8h.html#a76ed79b4650d01f82f1f517be07fe7c5" title="Convert a memory pointer (void*) into a hardware compatable memory address (uint64_t)...">cvmx_ptr_to_phys</a>(work_entry));
<a name="l00478"></a>00478 <span class="preprocessor">#endif</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span>
<a name="l00480"></a>00480     <span class="comment">/* If the user supplied a delete info structure then fill it in */</span>
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (delete_info) {
<a name="l00482"></a>00482         <span class="comment">/* It would be very bad to delete a timer entry after, or during the</span>
<a name="l00483"></a>00483 <span class="comment">           timer&apos;s processing. During the processing could yield unpredicatable</span>
<a name="l00484"></a>00484 <span class="comment">           results, but after would always be bad. Modifying the entry after</span>
<a name="l00485"></a>00485 <span class="comment">           processing means we would be changing data in a buffer that has been</span>
<a name="l00486"></a>00486 <span class="comment">           freed, and possible allocated again. For this reason we store a</span>
<a name="l00487"></a>00487 <span class="comment">           commit cycle count in the delete structure. If we are after this</span>
<a name="l00488"></a>00488 <span class="comment">           count we will refuse to delete the timer entry. */</span>
<a name="l00489"></a>00489         delete_info-&gt;<a class="code" href="structcvmx__tim__delete__t.html#adfb48c0a4e2c83c7ca243ff4116ddfa4" title="After this time the timer can&amp;#39;t be changed.">commit_cycles</a> = cycles + (ticks_from_now - 2) * cvmx_tim-&gt;tick_cycles;
<a name="l00490"></a>00490         delete_info-&gt;<a class="code" href="structcvmx__tim__delete__t.html#a2ed9c072b995d7aaf2c5e41829257221" title="Where the work entry is.">timer_entry_ptr</a> = (uint64_t *) tim_entry_ptr;  <span class="comment">/* Cast to non-volatile type */</span>
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <a class="code" href="cvmx-asm_8h.html#aba15754e334ee6421677da94e8c5c69c">CVMX_SYNCWS</a>;        <span class="comment">/* Make sure the hardware timer unit can access valid data from L2 */</span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="keywordflow">return</span> <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba093734bbb3d3582b0f8ae0e5705606e5">CVMX_TIM_STATUS_SUCCESS</a>;
<a name="l00496"></a>00496 <span class="preprocessor">#endif </span><span class="comment">/* CVMX_BUILD_FOR_LINUX_USER */</span>
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 <span class="comment"></span>
<a name="l00499"></a>00499 <span class="comment">/**</span>
<a name="l00500"></a>00500 <span class="comment"> * Delete a timer entry scheduled using cvmx_tim_add_entry.</span>
<a name="l00501"></a>00501 <span class="comment"> * Deleting a timer will fail if it has already triggered or</span>
<a name="l00502"></a>00502 <span class="comment"> * might be in progress. The actual state of the work queue</span>
<a name="l00503"></a>00503 <span class="comment"> * entry isn&apos;t changed. You need to dispose of it properly.</span>
<a name="l00504"></a>00504 <span class="comment"> *</span>
<a name="l00505"></a>00505 <span class="comment"> * @param delete_info</span>
<a name="l00506"></a>00506 <span class="comment"> *               Structure passed to cvmx_tim_add_entry to store the</span>
<a name="l00507"></a>00507 <span class="comment"> *               information needed to delete a timer entry.</span>
<a name="l00508"></a>00508 <span class="comment"> * @return CVMX_TIM_STATUS_BUSY if the timer was not deleted, otherwise</span>
<a name="l00509"></a>00509 <span class="comment"> *         CVMX_TIM_STATUS_SUCCESS.</span>
<a name="l00510"></a>00510 <span class="comment"> */</span>
<a name="l00511"></a><a class="code" href="cvmx-tim_8h.html#ac7a93ab86146c8742f6e413c0d55c222">00511</a> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04b">cvmx_tim_status_t</a> <a class="code" href="cvmx-tim_8h.html#ac7a93ab86146c8742f6e413c0d55c222" title="Delete a timer entry scheduled using cvmx_tim_add_entry.">cvmx_tim_delete_entry</a>(<a class="code" href="structcvmx__tim__delete__t.html" title="Structure used to store state information needed to delete an already scheduled timer...">cvmx_tim_delete_t</a> * delete_info)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513 <span class="preprocessor">#ifdef CVMX_BUILD_FOR_LINUX_USER</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (<a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04b">cvmx_tim_status_t</a>)sysmips(<a class="code" href="cvmx-tim_8h.html#ac3c2d2f9982e8caa5a34538b397832b0">MIPS_CAVIUM_DISARM_TIMER</a>, delete_info, NULL);
<a name="l00515"></a>00515 <span class="preprocessor">#else</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span>    <span class="keyword">const</span> uint64_t cycles = <a class="code" href="cvmx-clock_8h.html#adfe1c5a79a6c19685293c0db6dab3322" title="Get cycle count based on the clock type.">cvmx_clock_get_count</a>(<a class="code" href="cvmx-clock_8h.html#a72edd1cfc6601809fea7ce5ce6c05965a8321dcbca3fb01c74c6e2fafa9ba4dd8" title="Alias for CVMX_CLOCK_SCLK.">CVMX_CLOCK_TIM</a>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="keywordflow">if</span> ((int64_t) (cycles - delete_info-&gt;<a class="code" href="structcvmx__tim__delete__t.html#adfb48c0a4e2c83c7ca243ff4116ddfa4" title="After this time the timer can&amp;#39;t be changed.">commit_cycles</a>) &lt; 0) {
<a name="l00519"></a>00519         <span class="comment">/* Timer is far enough away. Safe to delete */</span>
<a name="l00520"></a>00520         *delete_info-&gt;<a class="code" href="structcvmx__tim__delete__t.html#a2ed9c072b995d7aaf2c5e41829257221" title="Where the work entry is.">timer_entry_ptr</a> = 0;
<a name="l00521"></a>00521         <span class="keywordflow">return</span> <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba093734bbb3d3582b0f8ae0e5705606e5">CVMX_TIM_STATUS_SUCCESS</a>;
<a name="l00522"></a>00522     } <span class="keywordflow">else</span> {
<a name="l00523"></a>00523         <span class="comment">/* Timer is passed the commit time. It cannot be stopped */</span>
<a name="l00524"></a>00524         <span class="keywordflow">return</span> <a class="code" href="cvmx-tim_8h.html#a418ec95de84483addab4de22b13de04ba69d4c652d57d7cfddc74eede38e59dd6">CVMX_TIM_STATUS_BUSY</a>;
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526 <span class="preprocessor">#endif </span><span class="comment">/* CVMX_BUILD_FOR_LINUX_USER */</span>
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 <span class="preprocessor">#ifdef  __cplusplus</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span><span class="comment">/* *INDENT-OFF* */</span>
<a name="l00531"></a>00531 }
<a name="l00532"></a>00532 <span class="comment">/* *INDENT-ON* */</span>
<a name="l00533"></a>00533 <span class="preprocessor">#endif</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span>
<a name="l00535"></a>00535 <span class="preprocessor">#endif // __CVMX_TIM_H__</span>
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 27 Oct 2017 for Octeon Software Development Kit by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
