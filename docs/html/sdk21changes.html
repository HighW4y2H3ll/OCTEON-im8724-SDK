<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Octeon Software Development Kit: IPD, PKO, SSO, and Config Changes in SDK-2.1</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="sdk21changes">IPD, PKO, SSO, and Config Changes in SDK-2.1 </a></h1><ul>
<li><a class="el" href="sdk21changes.html#sdk21changes_ipd_port">1. IPD port</a></li>
<li><a class="el" href="sdk21changes.html#sdk21changes_pkind">2. IPD pkind</a></li>
<li><a class="el" href="sdk21changes.html#sdk21changes_wqe">3. Work Queue Entry</a></li>
<li><a class="el" href="sdk21changes.html#sdk21changes_pko_port">4. PKO internal port</a></li>
<li><a class="el" href="sdk21changes.html#sdk21changes_pko_api">5. PKO API changes</a></li>
<li><a class="el" href="sdk21changes.html#sdk21changes_sso">6. SSO</a></li>
<li><a class="el" href="sdk21changes.html#sdk21changes_config">7. Configuration</a></li>
<li><a class="el" href="sdk21changes.html#sdk21changes_minchanges">8. The minimum changes for an SDK-2.0 SE app to migrate to SDK-2.1</a></li>
</ul>
<h2><a class="anchor" id="sdk21changes_ipd_port">
1. IPD port</a></h2>
<p>On CN68XX the IPD port numbering has changed compared to previous chips. As a result IPD port numbers and the PKO internal port numbers can no longer be identical as they can be on previous chips. (See HRM section 9.7.1 on WORD2[PORT] for details).</p>
<p>One consequence of this change is that arrays indexed by the IPD port as well as the routines that access these arrays may need to be modified.</p>
<p>In addition, one can no longer assume the IPD ports for the physical ports on an interface are contiguous. That is, not all values between the first and the last IPD ports obtained by calling </p>
<div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-util_8h.html#ac69b51d759069d618cfe05f56d8df395" title="Returns the IPD/PKO port number for the first port on the given interface.">cvmx_helper_get_first_ipd_port</a>(<span class="keywordtype">int</span> interface)
</pre></div><p> and </p>
<div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-util_8h.html#a6ad7d7a9edbb0f2328de8f30a72cb5f1" title="Returns the IPD/PKO port number for the last port on the given interface.">cvmx_helper_get_last_ipd_port</a>(<span class="keywordtype">int</span> interface)
</pre></div><p> respectively are valid IPD ports for some interfaces. For example, the four ports on the gmx0 interface in SGMII mode have IPD ports of 2048, 2064, 2080, and 2096, respectively.</p>
<p>The following table has IPD ports for CN6800 model:</p>
<div class="fragment"><pre class="fragment">
	INTERFACE   QLM   PORT NUMBER
	------------------------------------------------------------------
	SGMII       0     2048,2064,2080,2096
	XAUI/RXAUI  0     2112
	RXAUI       1     2368
	SGMII       2     2560,2576,2592,2608
	XAUI        2     2624
	SGMII       3     2816,2832,2848,2864
	XAUI        3     2880
	SGMII       4     3072,3088,3104,3120
	XAUI        4     3136
	ILK         1     1024,1025,1026,1027,1028,1029,1030,1031
	ILK         2     1280,1281,1282,1283,1284,1285,1286,1287
	------------------------------------------------------------------
	</pre></div><h2><a class="anchor" id="sdk21changes_pkind">
2. IPD pkind</a></h2>
<p>To aggregate ports (as there are potentially many more now) for certain operations, pkind and bpid are introduced in CN68XX. By default, however, the SDK assigns one pkind and one bpid to each physical port and the user does not have to configure them.</p>
<p>The API does provide query functions </p>
<div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-util_8c.html#a2e063bd86eddaab06d8962136d3c958d" title="Get port kind for a given port in an interface.">cvmx_helper_get_pknd</a>(<span class="keywordtype">int</span> interface, <span class="keywordtype">int</span> port);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-util_8c.html#a07d5151c9d70ebfb929b6041bcea0304" title="Get bpid for a given port in an interface.">cvmx_helper_get_bpid</a>(<span class="keywordtype">int</span> interface, <span class="keywordtype">int</span> port);
</pre></div><p> for pkind and bpid.</p>
<h2><a class="anchor" id="sdk21changes_wqe">
3. Work Queue Entry</a></h2>
<p>The work queue entry format has changed in CN68XX. Wrappers are created to access the fields in a chip-independent way. </p>
<div class="fragment"><pre class="fragment">        <span class="keywordtype">void</span> <a class="code" href="cvmx-wqe_8h.html#afb2389ac24f38c764dbf9030f9b429a4">cvmx_wqe_set_port</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work, <span class="keywordtype">int</span> port);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-wqe_8h.html#a9570b015bdd999612c72c3200ed1730b">cvmx_wqe_get_port</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work);
        <span class="keywordtype">void</span> <a class="code" href="cvmx-wqe_8h.html#af0929172c2fe412b20df8a6dbf5bda79">cvmx_wqe_set_grp</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work, <span class="keywordtype">int</span> grp);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-wqe_8h.html#a42f948f24b1e68bde1c6fc0ca79832b1">cvmx_wqe_get_grp</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work);
        <span class="keywordtype">void</span> <a class="code" href="cvmx-wqe_8h.html#a46762d5ca42a4421ec26e02773515ece">cvmx_wqe_set_qos</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work, <span class="keywordtype">int</span> qos);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-wqe_8h.html#ac453f4e519c8a9b8b250ea4d375ceb21">cvmx_wqe_get_qos</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work);
        <span class="keywordtype">void</span> <a class="code" href="cvmx-wqe_8h.html#aa50f7e118bf2bc0196139ed2590e40de">cvmx_wqe_set_tag</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work, uint32_t tag);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-wqe_8h.html#a11f6f624231512b827c891f0c10b9777">cvmx_wqe_get_tag</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work);
        <span class="keywordtype">void</span> <a class="code" href="cvmx-wqe_8h.html#a2bbabe564703cf12a5920d4e92663cd3">cvmx_wqe_set_tt</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work, <span class="keywordtype">int</span> tt);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-wqe_8h.html#a5f37b821beefb73dabf798425999c76e">cvmx_wqe_get_tt</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work);
        <span class="keywordtype">void</span> <a class="code" href="cvmx-wqe_8h.html#aa84f93905cf1f1ec422d23e4de8e4396">cvmx_wqe_set_len</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work, <span class="keywordtype">int</span> len);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-wqe_8h.html#aa143d399e373efcfa8774e72d5c20e1e">cvmx_wqe_get_len</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work);
        <span class="keywordtype">void</span> <a class="code" href="cvmx-wqe_8h.html#aa0b3118686ff0fb29eb003defe611e90">cvmx_wqe_set_unused8</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work, <span class="keywordtype">int</span> v);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-wqe_8h.html#ad661edcbfdf1d02f1ff6daf590d6bc9d">cvmx_wqe_get_unused8</a>(<a class="code" href="structcvmx__wqe__s.html" title="Work queue entry format.">cvmx_wqe_t</a> *work);
</pre></div><h2><a class="anchor" id="sdk21changes_pko_port">
4. PKO internal port</a></h2>
<p>The PKO internal ports increase in number (128 for CN68XX) and are contiguous starting from 0.</p>
<div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-util_8c.html#a0e206117af6ff3e7d97ace1568389d21" title="Returns the PKO port number for a port on the given interface, This is the base pko_port...">cvmx_helper_get_pko_port</a>(<span class="keywordtype">int</span> interface, <span class="keywordtype">int</span> port);
</pre></div><p> is added to query the PKO internal port of a physical port. As one can assign more than one PKO internal ports to a physical port (not supported yet). The function returns the first. By default, SDK-2.1 assigns only one PKO port to a physical port.</p>
<p>Assigning more than one PKO ports to a physical port is to be supported in future releases.</p>
<h2><a class="anchor" id="sdk21changes_pko_api">
5. PKO API changes</a></h2>
<ul>
<li>Lockless PKO via ENABLE_LOCKLESS_PKO is not supported in SDK-2.1. <br/>
 ``Lockless'' refers to the way queues are allocated and used and should be decided by the application. <div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> cvmx_pko_get_base_queue_per_core(<span class="keywordtype">int</span> port, <span class="keywordtype">int</span> core)
</pre></div> is no longer valid for chips starting from CN68XX.</li>
</ul>
<p>When locking is undesirable, one can allocate more than one queue for a port via CVMX_HELPER_PKO_QUEUES_PER_PORT_XXX or other means, call <a class="el" href="cvmx-hwpko_8h.html#a555e056b13146a6e8205a584e5929bf7" title="For a given port number, return the base pko output queue for the port.">cvmx_pko_get_base_queue()</a> and <a class="el" href="cvmx-hwpko_8h.html#a41d5c2af8ea492ad418ca9bce0d1a286" title="For a given port number, return the number of pko output queues.">cvmx_pko_get_num_queues()</a> to learn the range of queues available, schedule the queue on which a core should send, and call the PKO send functions with the ``use_locking'' parameter of CVMX_PKO_LOCK_NONE.</p>
<ul>
<li><div class="fragment"><pre class="fragment">        <a class="code" href="unioncvmx__pko__status.html" title="cvmx_pko_status">cvmx_pko_status_t</a> <a class="code" href="cvmx-hwpko_8h.html#af5569b7891fa94378b14f0dac78587cd" title="Configure a output port and the associated queues for use.">cvmx_pko_config_port</a>(uint64_t port, uint64_t base_queue, uint64_t num_queues, <span class="keyword">const</span> uint64_t priority[])
</pre></div> always returns CVMX_PKO_SUCCESS but does nothing for o68. <br/>
 As the PKO queues are statically configured, this function is called within the PKO setup framework and it is no longer necessary for the SE app to call it explicitly.</li>
</ul>
<ul>
<li>New functions taking the PKO port as a parameter<br/>
 Functions with the suffix _pkoid are more efficient than the ones without. The latter take the IPD port as a parameter and have to look up the PKO port. <div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> <a class="code" href="cvmx-hwpko_8h.html#aee0161a8c7c96d5db5fee5d68dec4a34" title="For a given PKO port number, return the base output queue for the port.">cvmx_pko_get_base_queue_pkoid</a>(<span class="keywordtype">int</span> pko_port);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-hwpko_8h.html#abe0cd15d43a053803d582792c5373bd0" title="For a given PKO port number, return the number of output queues for the port.">cvmx_pko_get_num_queues_pkoid</a>(<span class="keywordtype">int</span> pko_port);
        <span class="keywordtype">void</span> <a class="code" href="cvmx-hwpko_8h.html#a20b11aab92572453a6dbcc6684b38034" title="Ring the packet output doorbell.">cvmx_pko_doorbell_pkoid</a>(uint64_t pko_port, uint64_t queue, uint64_t len);
        <a class="code" href="unioncvmx__pko__status.html" title="cvmx_pko_status">cvmx_pko_status_t</a> <a class="code" href="cvmx-pko_8h.html#a6927c56f82a3c604f185bc5c858e75dc" title="Complete packet output.">cvmx_pko_send_packet_finish_pkoid</a>(<span class="keywordtype">int</span> pko_port, uint64_t queue,
            <a class="code" href="unioncvmx__pko__command__word0__t.html" title="Structure of the first packet output command word.">cvmx_pko_command_word0_t</a> pko_command, <a class="code" href="unioncvmx__buf__ptr.html" title="This structure defines a buffer pointer on Octeon.">cvmx_buf_ptr_t</a> packet, <a class="code" href="cvmx-hwpko_8h.html#ad498952219aa20f83ef1817869cdea84" title="This enumeration represents the differnet locking modes supported by PKO.">cvmx_pko_lock_t</a> use_locking);
        <a class="code" href="unioncvmx__pko__status.html" title="cvmx_pko_status">cvmx_pko_status_t</a> <a class="code" href="cvmx-pko_8h.html#a3b0176e7c6612ffca06e35d64b72bc43" title="Complete packet output.">cvmx_pko_send_packet_finish3_pkoid</a>(uint64_t pko_port, uint64_t queue,
            <a class="code" href="unioncvmx__pko__command__word0__t.html" title="Structure of the first packet output command word.">cvmx_pko_command_word0_t</a> pko_command, <a class="code" href="unioncvmx__buf__ptr.html" title="This structure defines a buffer pointer on Octeon.">cvmx_buf_ptr_t</a> packet, uint64_t addr,
            <a class="code" href="cvmx-hwpko_8h.html#ad498952219aa20f83ef1817869cdea84" title="This enumeration represents the differnet locking modes supported by PKO.">cvmx_pko_lock_t</a> use_locking);
</pre></div></li>
</ul>
<ul>
<li>New functions enabling multiple PKO ports per physical port<br/>
</li>
</ul>
<p>Two functions are added to support multiple PKO internal ports for a physical port: </p>
<div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-cfg_8c.html#aa37a4aa72325eca140a3d10c414b86bc">cvmx_helper_cfg_ipd2pko_port_base</a>(<span class="keywordtype">int</span> ipd_port);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-cfg_8c.html#a93781770065bf901cd8d3ebfcd830edf">cvmx_helper_cfg_ipd2pko_port_num</a>(<span class="keywordtype">int</span> ipd_port);
</pre></div><p>One specifies the ``(pko_port_base, pko_port_num)'' pair to assign the PKO ports </p>
<div class="fragment"><pre class="fragment">
	    pko_port_base, pko_port_base + 1, ..., pko_port_base + pko_port_num - 1
	</pre></div><p> to a physical port. See <a class="el" href="sdk21static_config.html">A Static Configuration Scheme in SDK-2.1 (Experimental)</a> for details.</p>
<ul>
<li>Assign priorities to PKO queues</li>
</ul>
<p>When a PKO port has multiple queues, earlier SDKs support assigning PKO queue priorities via a callback function which, by default, is defined as </p>
<div class="fragment"><pre class="fragment">            <a class="code" href="cvmx-platform_8h.html#a845de1642e5d22d87bd00b994bdcd82e">CVMX_SHARED</a> void (*<a class="code" href="cvmx-helper-pko_8c.html#a135343af1f5a21bdc8001c5a841d2f47" title="cvmx_override_pko_queue_priority(int pko_port, uint64_t priorities[16]) is a function...">cvmx_override_pko_queue_priority</a>)(<span class="keywordtype">int</span> ipd_port,
            uint64_t *priorities) = NULL;
</pre></div><p>The form is unchanged in SDK-2.1 but when using it in CN68XX the user should be aware of the following. First, the divergence of IPD and PKO ports means that the first parameter of the function, ipd_port, is really a PKO port in CN68XX. Second, the second parameter, priorities, is populated by 32 (the maximum number of queues per PKO port in CN68XX) 8s by default.</p>
<h2><a class="anchor" id="sdk21changes_sso">
6. SSO</a></h2>
<p>All POW CSRs are renamed in CN68XX consistent with the block being renamed to SSO. There is a new SSO initialization routine implemented as specified in the HRM. </p>
<div class="fragment"><pre class="fragment">        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper_8h.html#aa245500f20fc9158305d5348d81ecb3d" title="Initialize and allocate memory for the SSO.">cvmx_helper_initialize_sso</a>(<span class="keywordtype">int</span> wqe_entries);
</pre></div><p> does this for SE applications. A </p>
<div class="fragment"><pre class="fragment"> <a class="code" href="cvmx-helper_8h.html#a46e5066895d68e6fe06e1a6de8eec341" title="Undo the effect of cvmx_helper_initialize_sso().">cvmx_helper_uninitialize_sso</a>() 
</pre></div><p> is to be added.</p>
<h2><a class="anchor" id="sdk21changes_config">
7. Configuration</a></h2>
<ul>
<li>The SDK-2.1 makes extensions under the existing (or legacy) config system. <br/>
 The user configures the number of PKO queues for a physical port by defining CVMX_PKO_QUEUES_PER_PORT_XXXX. Three new such macros are added for o68, <div class="fragment"><pre class="fragment">               <a class="code" href="executive-config_8h_8template.html#a5e9888bed18d81610d8ec66c8eb52a1e">CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE2</a>,
               <a class="code" href="executive-config_8h_8template.html#ab7b745c58ba1a4dc1957621495134b2a">CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE3</a>, and
               <a class="code" href="executive-config_8h_8template.html#aa2277e88988e3e95ea7c4bfb50975b36">CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE4</a>. 
</pre></div> Note that this method, though compatible with older SDK versions, shares the limitation that the number of queues defined is for each port on an interface. The user should pay close attention during configuration to prevent the total number of queues from exceeding the maximum available in the system.</li>
</ul>
<ul>
<li>A scheme for configuring simple options is added in SDK-2.1. <br/>
 This includes two functions, <div class="fragment"><pre class="fragment">        uint64_t <a class="code" href="cvmx-helper-cfg_8c.html#acb236908ed4227b07320befefe968eae">cvmx_helper_cfg_opt_get</a>(<a class="code" href="cvmx-helper-cfg_8h.html#adb36a300acbbb4f01cdcf64a9a5cfd9d">cvmx_helper_cfg_option_t</a> opt);
        <span class="keywordtype">int</span> <a class="code" href="cvmx-helper-cfg_8c.html#a8cd3c49f4d29c1ab90d1a4f8a7368e5f">cvmx_helper_cfg_opt_set</a>(<a class="code" href="cvmx-helper-cfg_8h.html#adb36a300acbbb4f01cdcf64a9a5cfd9d">cvmx_helper_cfg_option_t</a> opt, uint64_t val);
</pre></div> and the enum cvmx_helper_cfg_option. The only option is CVMX_HELPER_CFG_OPT_USE_DWB which controls the ``Don't Write Back'' (DWB) behavior for SSO, PKO, and the DMA engines. By default, DWB is set so that the components would send DWB requests to the CMI (See HRM 3.1.6 for details). Note that this should be set before the said components are enabled.</li>
</ul>
<ul>
<li>An experimental static configuration tool is added in SDK-2.1. Simply put, it takes a script written in Python and generates the code which allocates resources per user's request. See <a class="el" href="sdk21static_config.html">A Static Configuration Scheme in SDK-2.1 (Experimental)</a> for details. This tool is not officially supported and is subject to change.</li>
</ul>
<h2><a class="anchor" id="sdk21changes_minchanges">
8. The minimum changes for an SDK-2.0 SE app to migrate to SDK-2.1</a></h2>
<p>To summarize, here is a checklist for possible changes necessary for an SDK-2.0 SE app to work with SDK-2.1.</p>
<ul>
<li>Check the assumptions, if any, about IPD port.</li>
</ul>
<ul>
<li>``Lockless PKO'' should not be enabled by defining ENABLE_LOCKLESS_PKO. The effect can be achieved by allocating queues for a physical port and making sure each sending core uses a different queue to avoid locking.</li>
</ul>
<ul>
<li>Initialize SSO correctly.</li>
</ul>
<ul>
<li>When defining CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACEX, make sure the sum of PKO queues do not exceed the maximum. </li>
</ul>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 27 Oct 2017 for Octeon Software Development Kit by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
